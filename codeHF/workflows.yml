---
options:
  global: ""
  local:
    - "-b"
    - "--configuration json://$JSON"
    - "--aod-memory-rate-limit 2000000000"
    - "--shm-segment-size 16000000000"
    - "--min-failure-level error"

workflows:

  # Skimming

  o2-analysis-hf-track-index-skim-creator: &skim_creator
    executable: o2-analysis-hf-track-index-skim-creator
    dependencies:
      - o2-analysis-trackextension
      - o2-analysis-trackselection
    tables: [HFSELCOLLISION, HFSELTRACK, HF2PRONG, HF3PRONG]

  o2-analysis-hf-track-index-skim-creator-v0:
    <<: *skim_creator
    dependencies:
      - o2-analysis-trackextension
      - o2-analysis-trackselection
      - o2-analysis-lf-lambdakzerobuilder
    options: "--doCascades"
    tables: [HFSELCOLLISION, HFSELTRACK, HF2PRONG, HF3PRONG, HFCASCADE]

  # Candidate creators

  o2-analysis-hf-candidate-creator-2prong: &cand_creator
    dependencies:
      - o2-analysis-hf-track-index-skim-creator
    tables:
      default: [HFCANDP2BASE, HFCANDP2EXT]
      mc: [HFCANDP2MCREC, HFCANDP2MCGEN]

  o2-analysis-hf-candidate-creator-3prong:
    <<: *cand_creator
    tables:
      default: [HFCANDP3BASE, HFCANDP3EXT]
      mc: [HFCANDP3MCREC, HFCANDP3MCGEN]

  o2-analysis-hf-candidate-creator-dstar: {}

  o2-analysis-hf-candidate-creator-cascade:
    <<: *cand_creator
    tables:
      default: [HFCANDCASCBASE, HFCANDCASCEXT]
      mc: [HFCANDCASCMCREC, HFCANDCASCMCGEN]

  o2-analysis-hf-candidate-creator-x:
    <<: *cand_creator
    dependencies:
      - o2-analysis-hf-candidate-selector-jpsi
    tables:
      default: [HFCANDXBASE, HFCANDXEXT]
      mc: [HFCANDXMCREC, HFCANDXMCGEN]

  o2-analysis-hf-candidate-creator-xicc:
    <<: *cand_creator
    dependencies: o2-analysis-hf-candidate-selector-xic-to-p-k-pi
    tables:
      default: [HFCANDXICCBASE, HFCANDXICCEXT]
      mc: [HFCANDXICCMCREC, HFCANDXICCMCGEN]

  o2-analysis-hf-candidate-creator-chic:
    <<: *cand_creator
    dependencies:
      - o2-analysis-hf-candidate-selector-jpsi
    tables:
      default: [HFCANDCHICBASE, HFCANDCHICEXT]
      mc: [HFCANDCHICMCREC, HFCANDCHICMCGEN]

  o2-analysis-hf-candidate-creator-b0:
    <<: *cand_creator
    dependencies: o2-analysis-hf-candidate-selector-dplus-to-pi-k-pi
    tables:
      default: [HFCANDB0BASE, HFCANDB0EXT]
      mc: [HFCANDB0MCREC, HFCANDB0MCGEN]

  o2-analysis-hf-candidate-creator-bplus:
    <<: *cand_creator
    dependencies: o2-analysis-hf-candidate-selector-d0
    tables:
      default: [HFCANDBPLUSBASE, HFCANDBPLUSEXT]
      mc: [HFCANDBPMCREC, HFCANDBPMCGEN]

  o2-analysis-hf-candidate-creator-lb:
    <<: *cand_creator
    dependencies:
      - o2-analysis-hf-candidate-selector-lc
      - o2-analysis-alice3-centrality
    tables:
      default: [HFCANDLB, HFCANDLBEXT]
      mc: [HFCANDLBMCREC, HFCANDLBMCGEN]

  # Selectors

  o2-analysis-hf-candidate-selector-d0: &selector_2prong
    dependencies:
      - o2-analysis-hf-candidate-creator-2prong
      - o2-analysis-pid-tpc-full
      - o2-analysis-pid-tof-full
    tables: HFSELD0CAND

  o2-analysis-hf-candidate-selector-jpsi: &selector_jpsi
    <<: *selector_2prong
    executable: o2-analysis-hf-candidate-selector-jpsi
    tables: HFSELJPSICAND

  o2-analysis-hf-candidate-selector-jpsi-alice3:
    <<: *selector_jpsi
    options: --isAlice3

  o2-analysis-hf-candidate-selector-dplus-to-pi-k-pi: &selector_3prong
    dependencies:
      - o2-analysis-hf-candidate-creator-3prong
      - o2-analysis-pid-tpc-full
      - o2-analysis-pid-tof-full
      - o2-analysis-pid-bayes
    tables: HFSELDPLUSCAND

  o2-analysis-hf-candidate-selector-ds-to-k-k-pi:
    <<: *selector_3prong
    tables: HFSELDSCAND

  o2-analysis-hf-candidate-selector-lb-to-lc-pi:
    dependencies: o2-analysis-hf-candidate-creator-lb
    tables: HFSELLBCAND

  o2-analysis-hf-candidate-selector-lc:
    <<: *selector_3prong
    tables: HFSELLCCAND

  o2-analysis-hf-candidate-selector-xic-to-p-k-pi:
    <<: *selector_3prong
    tables: HFSELXICCAND

  o2-analysis-hf-candidate-selector-lc-to-k0s-p:
    dependencies:
      - o2-analysis-hf-candidate-creator-cascade
      - o2-analysis-pid-tpc-full
      - o2-analysis-pid-tof-full
    tables: HFSELLCK0SPCAND

  o2-analysis-hf-candidate-selector-x-to-jpsi-pi-pi:
    dependencies: o2-analysis-hf-candidate-creator-x
    tables: HFSELXCAND

  o2-analysis-hf-candidate-selector-xicc-to-p-k-pi-pi:
    dependencies: o2-analysis-hf-candidate-creator-xicc
    tables: HFSELXICCCAND

  o2-analysis-hf-candidate-selector-chic-to-jpsi-gamma:
    dependencies: o2-analysis-hf-candidate-creator-chic
    tables: HFSELCHICCAND

  o2-analysis-hf-candidate-selector-b0-to-d-pi:
    dependencies: o2-analysis-hf-candidate-creator-b0
    tables: HFSELB0CAND

  o2-analysis-hf-candidate-selector-bplus-to-d0-pi:
    dependencies: o2-analysis-hf-candidate-creator-bplus
    tables: HFSELBPLUSCAND

  # Analysis tasks

  o2-analysis-hf-task-d0:
    dependencies: o2-analysis-hf-candidate-selector-d0

  o2-analysis-hf-task-jpsi:
    options:
      mc: "--doMC"
    dependencies:
      - o2-analysis-hf-candidate-selector-jpsi

  o2-analysis-hf-task-dplus:
    dependencies: o2-analysis-hf-candidate-selector-dplus-to-pi-k-pi

  o2-analysis-hf-task-ds:
    dependencies: o2-analysis-hf-candidate-selector-ds-to-k-k-pi

  o2-analysis-hf-task-lc:
    dependencies: o2-analysis-hf-candidate-selector-lc

  o2-analysis-hf-task-lb:
    dependencies: [o2-analysis-hf-candidate-selector-lb-to-lc-pi, o2-analysis-trackextension-alice3]

  o2-analysis-hf-task-xic:
    dependencies: o2-analysis-hf-candidate-selector-xic-to-p-k-pi

  o2-analysis-hf-task-b0:
    dependencies: o2-analysis-hf-candidate-selector-b0-to-d-pi

  o2-analysis-hf-task-bplus:
    dependencies: o2-analysis-hf-candidate-selector-bplus-to-d0-pi

  o2-analysis-hf-task-x:
    options:
      mc: "--doMC"
    dependencies: o2-analysis-hf-candidate-selector-x-to-jpsi-pi-pi

  o2-analysis-hf-task-lc-to-k0s-p:
    dependencies: o2-analysis-hf-candidate-selector-lc-to-k0s-p

  o2-analysis-hf-task-xicc:
    options:
      mc: "--doMC"
    dependencies: o2-analysis-hf-candidate-selector-xicc-to-p-k-pi-pi

  o2-analysis-hf-task-chic:
    options:
      mc: "--doMC"
    dependencies: o2-analysis-hf-candidate-selector-chic-to-jpsi-gamma

  o2-analysis-hf-task-correlation-d-dbar: &taskddbar
    executable: o2-analysis-hf-task-correlation-d-dbar

  o2-analysis-hf-task-correlation-d-dbar-mc-rec:
    <<: *taskddbar
    requires_mc: yes

  o2-analysis-hf-task-correlation-d-dbar-mc-gen:
    <<: *taskddbar
    requires_mc: yes

  o2-analysis-hf-task-flow:
    dependencies:
      - o2-analysis-hf-candidate-selector-d0

  # Tree creators

  o2-analysis-hf-tree-creator-d0-to-k-pi:
    requires_mc: yes
    dependencies: o2-analysis-hf-candidate-selector-d0
    tables: [HFCANDP2Full, HFCANDP2FullE, HFCANDP2FullP]

  o2-analysis-hf-tree-creator-lc-to-p-k-pi:
    requires_mc: yes
    dependencies: o2-analysis-hf-candidate-selector-lc
    tables: [HFCANDP3Full, HFCANDP3FullE, HFCANDP3FullP]

  o2-analysis-hf-tree-creator-bplus-to-d0-pi:
    requires_mc: yes
    dependencies: o2-analysis-hf-candidate-selector-bplus-to-d0-pi
    tables: [HFCANDBPFull, HFCANDBPFullE, HFCANDBPFullP]

  o2-analysis-hf-tree-creator-lb-to-lc-pi:
    requires_mc: yes
    dependencies: [o2-analysis-hf-candidate-selector-lb-to-lc-pi, o2-analysis-trackextension-alice3]
    tables: [HFCANDLbFull, HFCANDLbFullE, HFCANDLbFullP]

  o2-analysis-hf-tree-creator-x-to-jpsi-pi-pi:
    requires_mc: yes
    dependencies: o2-analysis-hf-candidate-selector-x-to-jpsi-pi-pi
    tables: [HFCANDXFull, HFCANDXFullE, HFCANDXFullP]

  o2-analysis-hf-tree-creator-xicc-to-p-k-pi-pi:
    requires_mc: yes
    dependencies: o2-analysis-hf-candidate-selector-xicc-to-p-k-pi-pi
    tables: [HFCANDXiccFull, HFCANDXiccFullE, HFCANDXiccFullP]

  o2-analysis-hf-tree-creator-chic-to-jpsi-gamma:
    requires_mc: yes
    dependencies: o2-analysis-hf-candidate-selector-chic-to-jpsi-gamma
    tables: [HFCANDChicFull, HFCANDChicFullE, HFCANDChicFullP]

  # D meson correlations

  o2-analysis-hf-correlator-d0-d0bar: &d0d0barcorr
    executable: o2-analysis-hf-correlator-d0-d0bar
    dependencies: [o2-analysis-hf-candidate-selector-d0, o2-analysis-alice3-centrality]
    tables: [DDBARPAIR, DDBARRECOINFO]

  o2-analysis-hf-correlator-d0-d0bar-mc-rec:
    <<: *d0d0barcorr
    options: "--doMCRec"

  o2-analysis-hf-correlator-d0-d0bar-mc-gen:
    <<: *d0d0barcorr
    options: "--doMCGen"
    tables: DDBARPAIR

  o2-analysis-hf-correlator-dplus-dminus: &dplusdminus
    executable: o2-analysis-hf-correlator-dplus-dminus
    dependencies: [o2-analysis-hf-candidate-selector-dplus-to-pi-k-pi, o2-analysis-alice3-centrality]
    tables: [DDBARPAIR, DDBARRECOINFO]

  o2-analysis-hf-correlator-dplus-dminus-mc-rec:
    <<: *dplusdminus
    requires_mc: yes

  o2-analysis-hf-correlator-dplus-dminus-mc-gen:
    <<: *dplusdminus
    requires_mc: yes
    tables: DDBARPAIR

  # QA

  o2-analysis-qa-efficiency:
    requires_mc: yes
    dependencies: [o2-analysis-event-selection, o2-analysis-trackselection]

  o2-analysis-qa-event-track:
    requires_mc: yes
    dependencies: [o2-analysis-event-selection, o2-analysis-trackselection, o2-analysis-pid-tof-base]

  o2-analysis-hf-task-qa-pid-rejection:
    requires_mc: yes
    dependencies:
      - o2-analysis-hf-track-index-skim-creator
      - o2-analysis-pid-tpc-full
      - o2-analysis-pid-tof-full

  o2-analysis-pid-tof-qa-mc:
    requires_mc: yes
    dependencies:
      - o2-analysis-pid-tof-full
      - o2-analysis-pid-tof-beta

  o2-analysis-hf-task-mc-validation:
    requires_mc: yes
    dependencies: [o2-analysis-hf-candidate-creator-2prong, o2-analysis-hf-candidate-creator-3prong]

  # Helper tasks

  o2-analysis-timestamp: {}

  o2-analysis-trackselection:
    dependencies:
      - o2-analysis-trackextension

  o2-analysis-trackselection-alice3:
    executable: o2-analysis-alice3-trackselection

  o2-analysis-trackextension:
    dependencies: o2-analysis-timestamp

  o2-analysis-trackextension-alice3:
    executable: o2-analysis-alice3-trackextension

  o2-analysis-alice3-centrality:
    dependencies: o2-analysis-trackextension-alice3

  o2-analysis-event-selection:
    dependencies:
      - o2-analysis-timestamp

  o2-analysis-multiplicity-table:
    dependencies:
      - o2-analysis-event-selection # only Run3

  o2-analysis-centrality-table: {}

  o2-analysis-pid-tpc-full:
    dependencies:
      - o2-analysis-multiplicity-table
      - o2-analysis-timestamp

  o2-analysis-pid-tof-base: {}

  o2-analysis-pid-tof-full:
    dependencies: o2-analysis-pid-tof-base

  o2-analysis-pid-tof-full-alice3:
    executable: o2-analysis-alice3-pid-tof

  o2-analysis-pid-bayes:
    dependencies:
      - o2-analysis-pid-tof-full
      - o2-analysis-pid-tpc-full

  o2-analysis-pid-tof-beta: {}

  o2-analysis-mc-converter: {}

  o2-analysis-fdd-converter: {}

  o2-analysis-track-propagation: {}

  # LF

  o2-analysis-lf-lambdakzerobuilder:
    dependencies:
      - o2-analysis-timestamp
      - o2-analysis-trackextension
